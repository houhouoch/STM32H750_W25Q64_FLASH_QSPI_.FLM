# STM32H750 + W25Q64 QSPI 下载算法制作指南 (FLM)

本项目基于安富莱（Armfly）教程移植，专门针对 **STM32H750** 配合 **W25Q64** 外部 Flash 进行了底层适配与性能优化。通过编译生成的 `.FLM` 文件，可直接用于 Keil MDK 的 Flash 下载。

---

## 📂 1. 项目目录结构讲解

了解目录结构有助于快速定位修改点：

* **User/**：项目的灵魂，存放核心算法和硬件驱动。
    * `FlashDev.c`：**算法描述文件**。定义了 Flash 的名称、地址、大小和扇区参数。
    * `FlashPrg.c`：**算法逻辑实现**。包含 `Init`、`Erase`、`Program` 等核心函数，是 MDK 调用的入口。
    * `FlashOS.h`：MDK 算法标准头文件。
    * `bsp/`：**底层驱动包**。包含关键的 `bsp_qspi_w25q256.c/h`，负责 QSPI 的引脚初始化和指令通讯。
    * `fonts/`：例程自带的字库文件（算法工程通常不使用，可保留）。
    * `segger/`：HardFault 异常处理，用于调试。
* **Project/**：存放 MDK-ARM 工程文件及编译输出。
    * 编译成功的 `.FLM` 算法文件会生成在此目录下。
* **Libraries/**：官方固件库。
    * 包含 STM32H7 的 **HAL 库** 和 **CMSIS** 核心支持文件，确保底层操作标准化。
* **Doc/**：项目相关说明文档及修改记录。

---

## 🛠️ 2. 硬件层适配 (核心修改点)

在移植驱动时，必须根据自己的硬件原理图对 `bsp_qspi_w25q256` 相关文件进行以下改动：

### 2.1 引脚复用与时钟 (bsp_qspi_w25q256.c)
* **复用端口号 (AF)**：这是最容易忽略的一点。请务必确认 QSPI 引脚对应的复用功能是 **AF9** 还是 **AF10**。
* **引脚使能宏**：修改引脚后，必须同步修改对应的 GPIO 时钟使能宏。
    ```c
    // 示例：如果 CS 引脚改到了其他端口，必须确保使能对应的时钟
    #define QSPI_CS_GPIO_CLK_ENABLE()   __HAL_RCC_GPIOB_CLK_ENABLE()
    ```

### 2.2 数据手册适配 (bsp_qspi_w25q256.h)
* **型号转换**：安富莱原工程针对的是 W25Q256，制作 W25Q64 算法时，需参考 **W25Q64 数据手册** 重新定义引脚。
* **Define 修正**：修改对应的宏定义，确保指令集和容量参数完全匹配硬件。

---

## ⚙️ 3. 算法描述配置 (FlashDev.c)

针对 W25Q64（8MB 容量），参数配置如下（这是算法能被识别的关键）：

```c
struct FlashDevice const FlashDevice  =  {
    FLASH_DRV_VERS,                   /* 驱动版本，勿修改 */
    "ARMFLY_STM32H7x_QSPI_W25Q64_TEST", /* 算法名，添加算法到 MDK 后显示的名称 */
    EXTSPI,                           /* 设备类型 */
    0x90000000,                       /* Flash 起始地址 */
    8 * 1024 * 1024,                  /* Flash 总大小 (8MB) */
    4 * 1024,                         /* 编程页大小 (性能与稳定的关键) */
    0,                                /* 保留，必须为 0 */
    0xFF,                             /* 擦除后的数值 */
    1000,                             /* 页编程等待时间 */
    6000,                             /* 扇区擦除等待时间 */
    64 * 1024, 0x000000,              /* 扇区大小 (64KB)，扇区起始地址 */
    SECTOR_END
};
```

---

## ⚠️ 4. 核心注意事项 (避坑经验总结)

### 🚀 稳定性绝招：编程页大小 (4 * 1024)
* **重要经验**：虽然 W25Q64 硬件物理页为 256 字节，但在 FLM 算法配置中，将编程页大小设置为 **4 * 1024 (4KB)** 是兼顾烧录性能与稳定的最佳选择，能大幅减少校验失败。

### 1. 时钟初始化 (必须 HSI)
在 `FlashPrg.c` 的 `Init` 函数中，**必须使用 HSI (内部高速振荡器)**。
* **避坑提示**：不要使用 HSE（外部晶振），防止因为硬件晶振起振慢或配置问题导致烧录时报 "Flash Timeout" 或 "Cannot access target"。

### 2. 严禁开启中断
下载算法运行在受限的 RAM 环境中。**严禁开启 Systick 或任何外设中断**：
* 驱动中的延时必须使用 **软件死循环延时**。
* 所有外设操作均需使用 **轮询模式 (Polling)**。

### 3. D-Cache 一致性 (H7 特有)
STM32H7 带有 Cache 缓存。建议在算法初始化阶段**直接关闭 D-Cache**。如果必须开启，操作完成后需手动刷新，防止校验读到旧缓存。

---

## ✅ 5. 如何验证算法

1.  编译工程，生成 `.FLM` 文件。
2.  将文件手动复制到 Keil 安装目录：`C:\Keil_v5\ARM\Flash`。
3.  在目标工程的 `Flash Download` 设置里点击 `Add`，找到此算法。
4.  点击 `Download` 进行测试，校验通过即代表移植成功。

---
/********************************** END **********************************/
